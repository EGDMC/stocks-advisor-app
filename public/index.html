<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EGX 30 Stock Advisor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .analysis-section { margin-bottom: 30px; }
        .chart-container { height: 400px; margin-bottom: 20px; }
        #loadingSpinner { display: none; }
        .error { color: red; }
        .indicator-card { margin-bottom: 15px; }
    </style>
</head>
<body>
    <!-- ... (keep the same HTML structure) ... -->

    <script>
        $(document).ready(function() {
            const API_BASE = '/api';  // Updated API base path
            
            $('#uploadForm').on('submit', async function(e) {
                e.preventDefault();
                
                const fileInput = $('#csvFile')[0];
                const file = fileInput.files[0];
                
                if (!file) {
                    showError('Please select a file');
                    return;
                }
                
                // Show loading state
                $('#loadingSpinner').show();
                hideAllSections();
                $('#errorMessage').hide();
                
                // Read file
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const csvContent = e.target.result;
                    
                    try {
                        const data = parseCSV(csvContent);
                        await runAnalysis(data);
                    } catch (error) {
                        showError('Analysis failed: ' + error.message);
                    } finally {
                        $('#loadingSpinner').hide();
                    }
                };
                
                reader.onerror = function() {
                    showError('Error reading file');
                };
                
                reader.readAsText(file);
            });
            
            async function runAnalysis(data) {
                try {
                    // Run analyses in parallel
                    const [smc, technical, patterns, trend, charts] = await Promise.all([
                        callEndpoint(`${API_BASE}/analyze`, data),
                        callEndpoint(`${API_BASE}/technical`, data),
                        callEndpoint(`${API_BASE}/pattern`, data),
                        callEndpoint(`${API_BASE}/trend`, data),
                        callEndpoint(`${API_BASE}/chart`, data)
                    ]);
                    
                    // Update UI with results
                    updateUI(smc, technical, patterns, trend, charts);
                    
                    // Show all sections
                    showAllSections();
                    
                } catch (error) {
                    throw new Error('Analysis failed: ' + error.message);
                }
            }
            
            async function callEndpoint(url, data) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ data })
                    });
                    
                    if (!response.ok) {
                        throw new Error('API call failed');
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('API call error:', error);
                    throw error;
                }
            }
            
            function parseCSV(content) {
                const lines = content.trim().split('\n');
                const headers = lines[0].toLowerCase().trim().split(',');
                const data = {
                    dates: [],
                    open: [],
                    high: [],
                    low: [],
                    close: [],
                    volume: []
                };
                
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].trim().split(',');
                    if (values.length === headers.length) {
                        data.dates.push(values[headers.indexOf('date')].trim());
                        data.open.push(parseFloat(values[headers.indexOf('open')]));
                        data.high.push(parseFloat(values[headers.indexOf('high')]));
                        data.low.push(parseFloat(values[headers.indexOf('low')]));
                        data.close.push(parseFloat(values[headers.indexOf('close')]));
                        data.volume.push(parseInt(values[headers.indexOf('volume')]));
                    }
                }
                
                return data;
            }
            
            function updateUI(smc, technical, patterns, trend, charts) {
                // Update charts
                if (charts && charts.charts) {
                    updateCharts(charts.charts);
                }
                
                // Update technical indicators
                if (technical && technical.indicators) {
                    updateIndicators(technical.indicators);
                }
                
                // Update patterns
                if (patterns && patterns.patterns) {
                    updatePatterns(patterns.patterns);
                }
                
                // Update trend
                if (trend) {
                    updateTrend(trend);
                }
                
                // Update SMC analysis
                if (smc) {
                    updateSMC(smc);
                }
            }
            
            function updateCharts(charts) {
                if (charts.price_chart) {
                    Plotly.newPlot('priceChart', charts.price_chart.data, {
                        title: 'Price Analysis',
                        height: 400,
                        margin: { t: 30 }
                    });
                }
                
                if (charts.technical_chart) {
                    Plotly.newPlot('trendChart', charts.technical_chart.data, {
                        title: 'Technical Analysis',
                        height: 400,
                        margin: { t: 30 }
                    });
                }
            }
            
            function updateIndicators(indicators) {
                const html = Object.entries(indicators)
                    .map(([key, value]) => `
                        <div class="col-md-4">
                            <div class="card indicator-card">
                                <div class="card-body">
                                    <h6>${formatName(key)}</h6>
                                    <p class="mb-0">${formatValue(value)}</p>
                                </div>
                            </div>
                        </div>
                    `)
                    .join('');
                
                $('#indicators').html(html);
            }
            
            function updatePatterns(patterns) {
                const html = Object.entries(patterns)
                    .map(([key, value]) => `
                        <div class="alert alert-info">
                            <strong>${formatName(key)}:</strong> ${value}
                        </div>
                    `)
                    .join('');
                
                $('#patterns').html(html);
            }
            
            function updateTrend(data) {
                const html = `
                    <div class="alert alert-${getTrendClass(data.current_trend)}">
                        <h6>Current Trend: ${data.current_trend}</h6>
                        <p>Confidence: ${data.confidence}%</p>
                        <p>Next Target: ${formatValue(data.next_target)}</p>
                    </div>
                `;
                
                $('#trendResult').html(html);
            }
            
            function updateSMC(data) {
                const html = `
                    <div class="alert alert-info">
                        <h6>Market Structure: ${data.market_structure}</h6>
                        <p>Current Setup: ${data.current_setup}</p>
                        <p>Key Levels:</p>
                        <ul>
                            <li>Support: ${formatValue(data.levels.support)}</li>
                            <li>Resistance: ${formatValue(data.levels.resistance)}</li>
                        </ul>
                    </div>
                `;
                
                $('#smcResult').html(html);
            }
            
            function hideAllSections() {
                $('.analysis-section').hide();
            }
            
            function showAllSections() {
                $('.analysis-section').show();
            }
            
            function showError(message) {
                $('#loadingSpinner').hide();
                hideAllSections();
                $('#errorMessage').show().text(message);
            }
            
            function formatName(name) {
                return name.split('_')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
            }
            
            function formatValue(value) {
                if (typeof value === 'number') {
                    if (value > 1000000) {
                        return (value / 1000000).toFixed(2) + 'M';
                    } else if (value > 1000) {
                        return (value / 1000).toFixed(2) + 'K';
                    }
                    return value.toFixed(2);
                }
                return value;
            }
            
            function getTrendClass(trend) {
                switch(trend.toLowerCase()) {
                    case 'bullish': return 'success';
                    case 'bearish': return 'danger';
                    default: return 'warning';
                }
            }
        });
    </script>
</body>
</html>